{% extends 'views/report.html' %}

{% block style %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.6.4/css/buttons.dataTables.min.css">
<style>
    #chart-container {
        width: 100%;
        height: 400px;
    }

    .list-menu {
        height: 100%;
    }

    .generate-button {
        display: flex;
        justify-content: flex-end;
    }

    .generate-button button {
        background-color: var(--color-menu);
        border: none;
        outline: none;
        box-shadow: none;
        margin: 0 5px;
        width: 27px;
        height: 27px;
        border-radius: 50%;
        color: var(--color-text);
        font-size: 12px;
        vertical-align: middle;
    }

    .item.active {
        background-color: var(--color-menu);
    }

    .select-list select,
    .select-list input {
        width: 130px;
        padding-left: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="wrap-container">

    <div class="row-wrapper">
        <div class="column-wrapper" style="width: 350px">
            <h5 class="color-font">Categories</h5>
            <hr>
            <div class="item-container">
                <div class="flex-between item active color-font" id="sale">
                    <p>Sale</p>
                    <p><i class="fa fa-caret-right" aria-hidden="true"></i></p>
                </div>
            </div>
        </div>
        <div class="border-right"></div>
        <div class="column-wrapper" style="width: 100%;">
            <div class="flex-between">
                <div class="select-list color-text">
                    <i class="fa fa-caret-right right" aria-hidden="true"></i>
                    From: <input type="date" class="input-color mx-1" id="start-date">
                    - <input type="date" class="input-color ml-1" id="end-date">
                </div>
                <div class="generate-button">
                    <button class="export-excel">
                        <i class="fa fa-file-excel-o" aria-hidden="true"></i>
                    </button>
                    <button class="export-pdf">
                        <i class="fa fa-file-pdf-o" aria-hidden="true"></i>
                    </button>
                    <button class="export-print">
                        <i class="fa fa-print" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
            <br>
            <div id="chart-container">
                <canvas id="canvas"></canvas>
            </div>
            <table id="export-table"></table>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.4/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.4/js/buttons.flash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.4/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.4/js/buttons.print.min.js"></script>
<script>
    var myChart = null

    function updateChart(value, label, start, end, id) {
        $.ajax({
            url: '/' + id,
            type: 'POST',
            data: { 'filter': value, 'start': start, 'end': end },
            success: function (data) {

                var dataObj = {
                    labels: [],
                    data: []
                }

                data.data.forEach(d => {
                    dataObj.labels.push(d.label)
                    dataObj.data.push(d.data)
                })

                myChart.data.labels = dataObj.labels

                myChart.data.datasets.forEach((dataset) => {
                    dataset.data = dataObj.data
                    dataset.label = label
                })

                myChart.update()


            }
        })
    }

    $(document).ready(function () {

        var chart = document.getElementById('chart-container')
        var canvas = document.getElementById('canvas')

        canvas.width = chart.offsetWidth
        canvas.height = chart.offsetHeight

        $(window).on('resize', function () {
            canvas.width = chart.offsetWidth
            canvas.height = chart.offsetHeight
        })

        $('.export-excel').on('click', function () {

            $('#export-table').html(`
                <thead>
                    <tr>
                        <td>Date</td>
                        <td>Result</td>
                    </tr>
                </thead>
                <tbody id="data-table">

                </tbody>`)


            myChart.data.labels.forEach((l, i) => {
                $('#data-table').append('<tr><td>' + l + '</td><td>' + myChart.data.datasets[0].data[i] + '</td></tr>')
            })

            $('#export-table').DataTable({
                "bDestroy": true,
                searching: false,
                paging: false,
                dom: 'Bfrtip',
                buttons: [
                    'excel', 'pdf', 'print'
                ]
            })

            $('.buttons-excel').click()
        })

        $('.export-pdf').on('click', function () {

            $('#export-table').html(`
                <thead>
                    <tr>
                        <td>Name</td>
                        <td>Result</td>
                    </tr>
                </thead>
                <tbody id="data-table">

                </tbody>`)


            myChart.data.labels.forEach((l, i) => {
                $('#data-table').append('<tr><td>' + l + '</td><td>' + myChart.data.datasets[0].data[i] + '</td></tr>')
            })

            $('#export-table').DataTable({
                searching: false,
                paging: false,
                dom: 'Bfrtip',
                "bDestroy": true,
                buttons: [
                    'excel', 'pdf', 'print'
                ]
            })

            $('.buttons-pdf').click()
        })

        $('.export-print').on('click', function () {

            $('#export-table').html(`
        <thead>
            <tr>
                <td>Date</td>
                <td>Result</td>
            </tr>
        </thead>
        <tbody id="data-table">

        </tbody>`)


            myChart.data.labels.forEach((l, i) => {
                $('#data-table').append('<tr><td>' + l + '</td><td>' + myChart.data.datasets[0].data[i] + '</td></tr>')
            })

            $('#export-table').DataTable({
                searching: false,
                paging: false,
                dom: 'Bfrtip',
                "bDestroy": true,
                buttons: [
                    'excel', 'pdf', 'print'
                ]
            })

            $('.buttons-print').click()
        })

        $('.item').on('click', function () {
            var items = document.querySelectorAll('.item')
            Array.from(items).forEach(i => {
                $(i).removeClass('active')
            })
            $(this).addClass('active')
            var start = $('#start-date').val()
            var end = $('#end-date').val()
            var value = $('#filter').val()
            var label = $('#filter option:selected').text()
            var id = $(this).attr('id')

            updateChart(value, label, start, end, id)
        })

        $('#start-date, #end-date').on('change', function () {
            var start = $('#start-date').val()
            var end = $('#end-date').val()
            var value = $('#filter').val()
            var label = $('#filter option:selected').text()
            var id = ''
            Array.from($('.item-container').children()).forEach(i => {
                if ($(i).hasClass('active')) {
                    id = $(i).attr('id')
                }
            })

            updateChart(value, label, start, end, id)
        })

        $.ajax({
            url: '/sale',
            type: 'POST',
            data: { 'filter': 'daily', 'start': null, 'end': null },
            success: function (data) {
                console.log(data)

                var chart = document.getElementById('chart-container')
                var canvas = document.getElementById('canvas')

                canvas.width = chart.offsetWidth
                canvas.height = chart.offsetHeight

                $(window).on('resize', function () {
                    canvas.width = chart.offsetWidth
                    canvas.height = chart.offsetHeight
                })

                var dataObj = {
                    labels: [],
                    data: []
                }

                data.data.forEach(d => {
                    dataObj.labels.push(d.label)
                    dataObj.data.push(d.data)
                })

                $('#start-date').val(data.oldest)
                $('#end-date').val(data.latest)

                var ctx = canvas.getContext('2d')
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dataObj.labels,
                        datasets: [{
                            label: 'Daily',
                            data: dataObj.data,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(255, 159, 64, 0.2)',
                                'rgba(54, 162, 235, 0.2)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(54, 162, 235, 1)',
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        legend: {
                            position: 'bottom',
                        },
                        hover: {
                            mode: 'label'
                        },
                        scales: {
                            xAxes: [{
                                display: true,
                                scaleLabel: {
                                    display: true
                                }
                            }],
                            yAxes: [{
                                display: true,
                                ticks: {
                                    beginAtZero: true,
                                    steps: 10,
                                    stepValue: 5
                                }
                            }]
                        }
                    }
                });
            }
        })
    })
</script>
{% endblock %}