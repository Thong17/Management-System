<!DOCTYPE html>
<html lang="en" data-theme="{{current_user.theme}}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome {% block title %}{% endblock %} </title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
        integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="{{url_for('static', filename='css/dist/style.css')}}">

    {% block style %}{% endblock %}
</head>

<body>
    <ul class="side-nav">
        <li>
            <button id="side-btn">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </li>
        <li>
            <a href="/">
                <i class="fa fa-home" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="/custome">
                <i class="fa fa-tasks" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="">
                <i class="fa fa-bar-chart" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="/setting">
                <i class="fa fa-sliders" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
    <header>
        <nav class="menu-nav">
            <div class="nav-logo">
                <i class="fa fa-terminal" aria-hidden="true"></i>
            </div>
            {% block navbar %}{% endblock %}
            <div class="dropdown">
                <button type="button" class="btn color-font" data-toggle="dropdown">
                    {{current_user.username}}
                </button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">Link 1</a>
                    <a class="dropdown-item" href="#">Link 2</a>
                    <a class="dropdown-item" href="#">Link 3</a>
                    <div class="dropdown-divider"></div>
                    <form action="/logout" method="post" style="width: auto;">
                        <input type="submit" value="Logout">
                    </form>
                </div>
            </div>
        </nav>
        <main>
            {% block content %}{% endblock %}
        </main>
    </header>
    <footer>
        <p class="color-font">Developed by thong</p>

    </footer>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.0/js/mdb.min.js"></script>
    <script src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/16327/gsap-latest-beta.min.js"></script>
    <script src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/16327/CSSRulePlugin3.min.js"></script>
    <script src="https://unpkg.com/ionicons@5.1.0/dist/ionicons.js"></script>
    <script src="{{url_for('static', filename='js/script.js')}}"></script>
    {% block script %}{% endblock %}
    <script>
        var theme = $('html').attr('data-theme')

        $.each($('#select-theme option'), function () {
            if ($(this).val() == theme) {
                $(this).attr('selected', 'selected')
            }
        })
        $('#side-btn').on('click', function () {
            $('.side-nav').toggleClass('nav-on')
        })
        $('#select-theme').on('change', function () {
            theme = $(this).children('option:selected').val()
            $.ajax({
                url: '/theme/change',
                method: 'POST',
                data: { data: theme },
                success: function (data) {
                    console.log(data)
                    $('html').attr('data-theme', data['theme'])
                }
            })

        })

        function toggleEdit(show, hide) {
            this.show = show
            this.hide = hide

            this.show.removeClass('hide')
            this.hide.addClass('hide')
        }

        function toggleLoader(loader) {
            this.loader = loader
            if (this.loader.hasClass('hide')) {
                this.loader.removeClass('hide')
            } else {
                this.loader.addClass('hide')
            }

        }

        function filterProducts(list, filter) {

        }

        function dynamicSort(property) {
            var sortOrder = 1;
            if(property[0] === "-") {
                sortOrder = -1;
                property = property.substr(1);
            }
            return function (a,b) {
                /* next line works with strings and numbers, 
                * and you may want to customize it to your needs
                */
                var result = (a[property] < b[property]) ? -1 : (a[property] > b[property]) ? 1 : 0;
                return result * sortOrder;
            }
        }

        function showProduct(element, id, product, category, photo, price) {
            this.element = element
            this.id = id
            this.product = product
            this.photo = photo
            this.price = price
            this.category = category
            this.element.append(`
                    <a class="product-item" id="`+ this.id + `" href="/product/` + this.id + `">
                        <div class="item-wrapper">
                            <div class="item-img">
                                <img src="static/uploads/`+ this.photo + `" alt="" srcset="">
                                <div class="product-btn color-text">
                                    <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                                    <i class="fa fa-trash-o" aria-hidden="true"></i>
                                </div>
                            </div>
                            <div class="item-details">
                                <div class="details">
                                    <p class="color-font text-wrapper" id="details-title" style="font-size: 14px;">`+ this.product + `</p>
                                    <p class="color-text" id="details-category" style="font-size: 12px;">`+ this.category + `</p>
                                </div>
                                <div class="flex-between-end color-text" style="width: 100%;">
                                    <p class="color-font text-wrapper" id="details-price" style="font-size: 14px; width: 100px;"><span class="symbol">$</span><span class="price-tag">`+ this.price + `</span></p>
                                    <p style="font-size: 12px;">
                                        <i class="fa fa-heart-o" aria-hidden="true"></i>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </a>`)
        }


        function showProductDetails(params) {
            var image = params.image
            var colors = params.colors
            var product = params.product
            var category = params.category
            var description = params.description
            var currency = params.currency
            var price = params.price
            var properties = params.properties
            var values = params.values
            var id = params.id

            var color_element = ''

            if (colors.length > 0) {
                colors.forEach(color => {
                    color_element += '<span style="background-color: ' + color.hex + '" title="' + color.color + '"></span>'
                });
            }

            if (currency == 'riel') {
                currency = 'R'
            } else {
                currency = '$'
            }

            var property_element = ''

            if (properties.length > 0) {
                properties.forEach(property => {
                    var value_element = '<button class="btn border btn-value color-font"><p class="plus">+</p></button>'
                    if (values.length > 0) {
                        values.forEach(value => {
                            if (value.currency == 'riel') {
                                value.currency = 'R'
                            } else {
                                value.currency = '$'
                            }
                            if (value.property == property.id) {
                                value_element += `<label class="value color-font container-input">
                                                    <div class="flex-between-start">
                                                        <div class="flex-column-start-start">
                                                            <h5>`+ value.value + `</h5>
                                                            <p style="font-size: 11px" class="color-text">`+ value.description + `</p>
                                                        </div>
                                                    </div>
                                                    <div class="flex-end color-text" style="font-size: 18px">
                                                        <p>`+ value.currency + `</p>
                                                        <p>`+ value.price + `</p>
                                                    </div>
                                                    <input type="radio" name="`+ property.id + `">
                                                    <span class="checkbox"></span>
                                                </label>`
                            }

                        });
                    }
                    property_element += `<div class="flex-column-start-start mt-4">
                                            <h5 class="color-font mb-3">` + property.property + `</h5>
                                            <button class="hide btn border color-font btn-slim add-value" id="`+ property.id + `" data-toggle="modal" data-target="#addValue"><p class="plus">+</p></button>
                                        </div>
                                        <div class="property-values" id="`+ property.id + `">
                                            `+ value_element + `
                                        </div>`
                });
            }

            return `<div class="product-details">
                        <div class="details-left">
                            <div class="details-img">
                                <img src="`+ image + `" alt="" srcset="">
                            </div>
                            <div class="details-colors">`+ color_element + `</div>
                            <p class="color-text mt-2" id="details-description" style="font-size: 12px; text-align: left">`+ description + `<p>
                        </div>
                        <div class="details-right">
                            <div class="details-details">
                                <div class="details">
                                    <p class="color-font text-wrapper details-title" id="`+ id + `" style="font-size: 23px;">` + product + `</p>
                                    <p class="color-text" id="details-category" style="font-size: 12px;">`+ category + `</p>
                                </div>
                                <div class="details-header" style="font-size: 23px">
                                    <span class="details-symbol color-font">`+ currency + `</span>
                                    <span class="details-price color-font">`+ price + `</span>
                                </div>
                            </div> 
                            <hr></hr>                           
                            <div class="details-property">`+ property_element + `</div>
                        </div>
                    </div>`
        }

        function showProductForm(params) {
            var category = params.category
            var product = params.product
            var price = params.price
            var description = params.description
            var colors = params.colors
            var element = ''
            if (colors.length > 0) {
                colors.forEach(color => {
                    element += '<option value="' + color.id + '">' + color.color + '</option>'
                });
            }
            var productForm = `<h5 class="color-font m-0">Product</h5>
                    <div class="slide-form" style="width: 100%;">
                        <form action="/product/add" method="post" enctype="multipart/form-data" style="width: 100%;"
                            id="product-form">
                            <h5 class="color-font sub-content"><i class="fa fa-caret-right right" aria-hidden="true"></i>Select Category</h5>
                            <input type="hidden" name="brand" id="brand-id">
                            <div class="form-group selector">
                                <p class="detail-content">Use category for specific products</p>
                                <select name="category" id="category" class="form-control input-color" required>
                                    <option disabled selected="selected" value="">Select category</option>
                                    {% if categories %}
                                        {% for category in categories %}
                                            <option value="{{category.id}}">{{category.category}}</option>
                                        {% endfor %}
                                    {% else %}
                                    <option value="">No category</option>
                                    {% endif %}
                                </select>
                            </div>
                            <h5 class="color-font sub-content mb-2"><i class="fa fa-caret-right right" aria-hidden="true"></i>Product Informations</h5>
                            <div class="form-group">
                                <input type="text" class="form-control input-color" name="product" id="product" value="`+ product + `" required>
                                <label for="product" class="label product">Product</label>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <input type="number" class="form-control input-color" name="price" id="price" value="`+ price + `"
                                            required>
                                        <label for="price" class="label price">Price</label>
                                    </div>
                                </div>
                                <div class="col-md-4 selector pl-0">
                                    <div class="form-group">
                                        <select name="currency" id="currency" class="form-control input-color">
                                            <option value="dollar"><span>&#36;</span></option>
                                            <option value="riel"><span>&#6107;</span></option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <textarea name="details" id="details"
                                    class="form-control input-color textarea" required>`+ description + `</textarea>
                                <label for="details" class="label details">Description</label>
                            </div>
                            
                            <input type="submit" value="Save" class="submit-btn hide">
                        </form>
                        
                        <div class="product-image hide">
                            <h5 class="color-font sub-content"><i class="fa fa-caret-right right" aria-hidden="true"></i>Product Appearance</h5>
                            <div class="form-group">
                                <p class="detail-content">Select product photo</p>
                                <div class="upload-container">
                                    <div class="image-containers" id="product-img">
                                        <div class="image-item">
                                            <img src="/static/uploads/default.png" id="product-src">
                                        </div>
                                    </div>
                                    <div class="bubbling hide">
                                        <img src="/static/svg/bubbling-{{current_user.theme}}.svg">
                                    </div>
                                    <label for="product-photo" class="upload-label">
                                        <input type="file" name="product-photo" id="product-photo" class="upload-input">
                                        <span><i class="fa fa-camera" aria-hidden="true"></i></span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group selector">
                                <p class="detail-content">Add color for product</p>
                                <div class="row">
                                    <div class="col-sm-9 pr-0 selector">
                                        <select name="color" id="color" class="form-control input-color" required>
                                            <option disabled selected="selected" value="">Select color</option>
                                            `+ element + `
                                        </select>   
                                    </div>
                                    <div class="col-sm-3" style="width=100%">
                                        <button class="btn pickr input-color" style="width: 100%">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <p class="detail-content">Select color photo: <span class="selected-color"></span></p>
                                <div class="upload-container">
                                    <div class="image-containers" id="color-img">
                                        <div class="image-item">
                                            <img src="/static/uploads/default.png" id="image-src">
                                        </div>
                                    </div>
                                    <div class="bubbling hide">
                                        <img src="/static/svg/bubbling-{{current_user.theme}}.svg">
                                    </div>
                                    <label for="photo" class="upload-label disabled">
                                        <input type="file" name="photo" id="photo" class="upload-input" multiple disabled>
                                        <span><i class="fa fa-camera" aria-hidden="true"></i></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-block border color-font submit-product">Create</button>
                    <button class="btn btn-block border color-font save-product hide">Save</button>`
            return productForm
        }

        function uuid() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8)
                return v.toString(16)
            })
        }

        function uploadPhoto(files, color, product, self, url) {

            const validtypes = ['image/gif', 'image/jpeg', 'image/png']
            this.color = color
            this.product = product
            this.url = url
            this.files = files
            this.self = self

            var imgtag = $(this.self).closest('.upload-container').find('.image-containers').attr('id')
            var name = $(this.self).closest('.slide-form').find('#product').val()
            var loader = $(this.self).closest('.upload-container').find('.bubbling')


            toggleLoader(loader)
            var form = new FormData()
            form.append('color', this.color)
            form.append('name', name)

            if (this.files.length > 0) {
                this.files.forEach((file, index) => {
                    if (jQuery.inArray(file.type, validtypes) == -1) {
                        console.log('Invalide file!')
                        toggleLoader(loader)
                        return false
                    } else {
                        if (file.size > 2000000) {
                            console.log('Image size too big ')
                            toggleLoader(loader)
                            return false
                        } else {
                            form.append(index, file)
                        }
                    }
                })

                $.ajax({
                    url: this.url + '/' + this.product,
                    type: 'post',
                    data: form,
                    contentType: false,
                    cache: false,
                    processData: false,
                    beforeSend: function () {

                    },
                    success: function (data) {
                        var element = ''
                        data.forEach(photo => {
                            element += `<div class="image-item">
                                            <img src="/static/uploads/`+ photo.photoSrc + `" alt="` + photo.photoAlt + `">
                                        </div>`
                        })
                        $('#' + imgtag).html(element)
                        setTimeout(function () {
                            toggleLoader(loader)
                            if (url = '/product/photo') {
                                $('.details-img').html('<img src="/static/uploads/' + data[0].photoSrc + '" alt="' + data[0].photoAlt + '">')
                            }
                        }, 1000)
                    }
                })
            } else {
                console.log('No file selected')
                toggleLoader(loader)
            }

        }

        function uploadColor(picker, input) {
            if ($('.pcr-app').length) {
                $('.pcr-app').remove()
            }
            this.picker = picker
            this.input = input
            const pickr = Pickr.create({
                el: this.picker,
                theme: 'classic', // or 'monolith', or 'nano'
                defaultRepresentation: 'HEX',
                default: '#111111',
                useAsButton: true,
                components: {

                    // Main components
                    preview: true,
                    opacity: true,
                    hue: true,

                    // Input / output Options
                    interaction: {
                        hex: false,
                        rgba: false,
                        hsla: false,
                        hsva: false,
                        cmyk: false,
                        input: true,
                        clear: false,
                        save: true
                    }
                }
            })

            $('.pcr-interaction').prepend('<input type="text" class="pcr-name" id="' + this.input + '" placeholder="Name" style="width: 50%; text-align: left">')


            pickr.on('save', (color, instance) => {
                $('.pcr-save').attr('disabled', true)
                const hex = color.toHEXA().toString()
                const name = $('#' + this.input).val()
                console.log(name)
                const id = $(this.picker).attr('id')
                if (name != '') {
                    $.ajax({
                        url: '/product/color/' + id,
                        type: 'post',
                        data: { 'hex': hex, 'color': name },
                        beforeSend: function () {

                        },
                        success: function (data) {
                            $('#color').append(`<option value="` + data.id + `">` + data.color + `</option>`)
                            $('.pcr-save').attr('disabled', false)
                            $('.details-colors').append(`<span style="background-color: ` + data.hex + `"></span>`)
                            $('.pcr-name').val('')
                            pickr.hide()
                        }
                    })
                } else {
                    $('#' + this.input).focus()
                    $('.pcr-save').attr('disabled', false)
                }
            })
        }

        $(document).on('click', '.add-value', function () {
            var property = $(this).attr('id')
            var title = $(this).prev('.sub-content').text()
            console.log(property, title)
            $('.modal-title').text(title)
            $('.save-btn').attr('id', property)
        })
        $('.save-btn').on('click', function () {
            var product = $('.details-title').attr('id')
            var property = $(this).attr('id')

            var value = $('#property-name').val()
            var price = $('#property-price').val()
            var currency = $('#property-currency').val()
            var description = $('#property-description').val()

            console.log(product, property, value, price, currency, description)

            $.ajax({
                url: '/value/add',
                method: 'POST',
                data: { product: product, property: property, value: value, price: price, currency: currency, description: description },
                success: function (data) {
                    console.log(data)
                    $('#addValue').modal('hide')
                    if (data.currency == 'riel') {
                        data.currency = 'R'
                    } else {
                        data.currency = '$'
                    }
                    $('.property-values#' + data.property).prepend(`<label class="value color-font container-input">
                                                    <div class="flex-between-start">
                                                        <div class="flex-column-start-start">
                                                            <h5>`+ data.value + `</h5>
                                                            <p style="font-size: 11px" class="color-text">`+ data.description + `</p>
                                                        </div>
                                                    </div>
                                                    <div class="flex-end color-text" style="font-size: 18px">
                                                        <p>`+ data.currency + `</p>
                                                        <p>`+ data.price + `</p>
                                                    </div>
                                                    <input type="radio" name="`+ data.property + `">
                                                    <span class="checkbox"></span>
                                                </label>`)
                }
            })
        })
        $(document).on('click', '.btn-value', function () {
            $(this).parent().prev().find('.add-value').click()
        })
    </script>
</body>

</html>